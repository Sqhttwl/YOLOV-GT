

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Design Doc: Python API &mdash; PaddlePaddle  文档</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="PaddlePaddle  文档" href="../index.html"/> 

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/perfect-scrollbar/0.6.14/css/perfect-scrollbar.min.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/override.css" type="text/css" />
  <script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?b9a314ab40d04d805655aab1deee08ba";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
  </script>

  

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  
  <header class="site-header">
    <div class="site-logo">
      <a href="/"><img src="../_static/images/PP_w.png"></a>
    </div>
    <div class="site-nav-links">
      <div class="site-menu">
        <a class="fork-on-github" href="https://github.com/PaddlePaddle/Paddle" target="_blank"><i class="fa fa-github"></i>Fork me on Github</a>
        <div class="language-switcher dropdown">
          <a type="button" data-toggle="dropdown">
            <span>English</span>
            <i class="fa fa-angle-up"></i>
            <i class="fa fa-angle-down"></i>
          </a>
          <ul class="dropdown-menu">
            <li><a href="/doc_cn">中文</a></li>
            <li><a href="/doc">English</a></li>
          </ul>
        </div>
        <ul class="site-page-links">
          <li><a href="/">Home</a></li>
        </ul>
      </div>
      <div class="doc-module">
        
        <ul>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/index_cn.html">新手入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index_cn.html">进阶指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_cn.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index_cn.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/index_cn.html">MOBILE</a></li>
</ul>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>        
      </div>
    </div>
  </header>
  
  <div class="main-content-wrap">

    
    <nav class="doc-menu-vertical" role="navigation">
        
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../getstarted/index_cn.html">新手入门</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getstarted/build_and_install/index_cn.html">安装与编译</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getstarted/build_and_install/pip_install_cn.html">使用pip安装</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getstarted/build_and_install/docker_install_cn.html">使用Docker安装运行</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/dev/build_cn.html">用Docker编译和测试PaddlePaddle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getstarted/build_and_install/build_from_source_cn.html">从源码编译</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getstarted/concepts/use_concepts_cn.html">基本使用概念</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index_cn.html">进阶指南</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/cmd_parameter/index_cn.html">设置命令行参数</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/use_case_cn.html">使用案例</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/arguments_cn.html">参数概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/usage/cmd_parameter/detail_introduction_cn.html">细节描述</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/cluster/cluster_train_cn.html">PaddlePaddle分布式训练</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/k8s/k8s_basis_cn.html">Kubernetes 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/k8s/k8s_cn.html">Kubernetes单机训练</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/usage/k8s/k8s_distributed_cn.html">Kubernetes分布式训练</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/dev/contribute_to_paddle_cn.html">如何贡献代码</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/dev/write_docs_cn.html">如何贡献/修改文档</a></li>
<li class="toctree-l2"><a class="reference internal" href="../howto/deep_model/rnn/index_cn.html">RNN相关模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howto/deep_model/rnn/rnn_config_cn.html">RNN配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/deep_model/rnn/recurrent_group_cn.html">Recurrent Group教程</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/deep_model/rnn/hierarchical_layer_cn.html">支持双层序列作为输入的Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howto/deep_model/rnn/hrnn_rnn_api_compare_cn.html">单双层RNN API对比介绍</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howto/optimization/gpu_profiling_cn.html">GPU性能分析与调优</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api/index_cn.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/model_configs.html">模型配置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/activation.html">Activation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/layer.html">Layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/evaluators.html">Evaluators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/optimizer.html">Optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/pooling.html">Pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/networks.html">Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/config/attr.html">Parameter Attribute</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/data.html">数据访问</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/data/data_reader.html">Data Reader Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/data/image.html">Image Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/v2/data/dataset.html">Dataset</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/v2/run_logic.html">训练与应用</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index_cn.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/build_and_install/index_cn.html">编译安装与单元测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/model/index_cn.html">模型配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/parameter/index_cn.html">参数设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/local/index_cn.html">本地训练与预测</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/cluster/index_cn.html">集群训练与预测</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mobile/index_cn.html">MOBILE</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../mobile/cross_compiling_for_android_cn.html">Android平台编译指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile/cross_compiling_for_ios_cn.html">iOS平台编译指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile/cross_compiling_for_raspberry_cn.html">Raspberry Pi平台编译指南</a></li>
</ul>
</li>
</ul>

        
    </nav>
    
    <section class="doc-content-wrap">

      

 







<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
      
    <li>Design Doc: Python API</li>
  </ul>
</div>
      
      <div class="wy-nav-content" id="doc-content">
        <div class="rst-content">
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="design-doc-python-api">
<span id="design-doc-python-api"></span><h1>Design Doc: Python API<a class="headerlink" href="#design-doc-python-api" title="永久链接至标题">¶</a></h1>
<p>Due to the refactorization of the PaddlePaddle core, we need Python classes to construct corresponding protobuf messages that describe a DL program.</p>
<p>| Python classes | Protobuf messages |
| &#8212; | &#8212; |
| Program | ProgramDesc |
| Block | BlockDesc |
| Operator | OpDesc |
| Variable | VarDesc |</p>
<p>Please be aware that these Python classes need to maintain some construction-time information, which are not part of the protobuf messages.</p>
<div class="section" id="core-concepts">
<span id="core-concepts"></span><h2>Core Concepts<a class="headerlink" href="#core-concepts" title="永久链接至标题">¶</a></h2>
<div class="section" id="program">
<span id="program"></span><h3>Program<a class="headerlink" href="#program" title="永久链接至标题">¶</a></h3>
<p>A <code class="docutils literal"><span class="pre">ProgramDesc</span></code> describes a <a class="reference external" href="https://github.com/PaddlePaddle/Paddle/blob/develop/doc/design/program.md">DL program</a>, which is composed of an array of <code class="docutils literal"><span class="pre">BlockDesc</span></code>s.  The <code class="docutils literal"><span class="pre">BlockDesc</span></code>s in a <code class="docutils literal"><span class="pre">ProgramDesc</span></code> can have a tree-like hierarchical structure. However, the <code class="docutils literal"><span class="pre">ProgramDesc</span></code> onlys stores a flattened array of <code class="docutils literal"><span class="pre">BlockDesc</span></code>s. A <code class="docutils literal"><span class="pre">BlockDesc</span></code> refers to its parent block by its index in the array.  For example, operators in the step block of an RNN operator need to be able to access variables in its ancestor blocks.</p>
<p>Whenever we create a block, we need to set its parent block to the current block, hence the Python class <code class="docutils literal"><span class="pre">Program</span></code> needs to maintain a data member <code class="docutils literal"><span class="pre">current_block</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Program</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">NewProgram</span><span class="p">()</span> <span class="c1"># a C++ ProgramDesc pointer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># the global block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># initialized to the global block</span>

    <span class="k">def</span> <span class="nf">global_block</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">current_block</span><span class="p">():</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_block</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span><span class="p">()</span><span class="o">.</span><span class="n">parent_idx</span>

    <span class="k">def</span> <span class="nf">create_block</span><span class="p">():</span>
        <span class="n">new_block_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_block</span> <span class="o">=</span> <span class="n">new_block_idx</span>
        <span class="k">return</span> <span class="n">current_block</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Program</span></code> is an accessor to the protobuf message <code class="docutils literal"><span class="pre">ProgramDesc</span></code>, which is created in C++ space, because the InferShape function is in C++, which manipulates <code class="docutils literal"><span class="pre">VarDesc</span></code> messages, which are in turn members of <code class="docutils literal"><span class="pre">BlockDesc</span></code>, which is a member of <code class="docutils literal"><span class="pre">ProgramDesc</span></code>.</p>
<p><code class="docutils literal"><span class="pre">Program</span></code> creates the first block as the global block in its constructor.  All parameters and their initializer operators are in the global block.</p>
</div>
<div class="section" id="block">
<span id="block"></span><h3>Block<a class="headerlink" href="#block" title="永久链接至标题">¶</a></h3>
<p>A <a class="reference external" href="https://github.com/PaddlePaddle/Paddle/blob/develop/doc/design/block.md">Block</a> includes</p>
<ol class="simple">
<li>a map from variable names to an instance of the Python <code class="docutils literal"><span class="pre">Variable</span></code> class, and</li>
<li>a list of <code class="docutils literal"><span class="pre">Operator</span></code> instances.</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Block</span><span class="p">(</span><span class="n">objects</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">program</span><span class="p">,</span> <span class="n">parent_idx</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">NewBlock</span><span class="p">(</span><span class="n">program</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">program</span> <span class="o">=</span> <span class="n">program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span> <span class="o">=</span> <span class="nb">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">Variable</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">Operator</span><span class="o">&gt;</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_idx</span> <span class="o">=</span> <span class="n">parent_idx</span>

    <span class="k">def</span> <span class="nf">create_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_global_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="n">program</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">create_var</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="c1"># Parameter is a subclass of variable. See Parameter section for details.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_global_var</span><span class="p">(</span><span class="o">...</span><span class="p">),</span> <span class="o">...</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">append_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">prepend_operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span> <span class="c1"># Parameter&#39;s ctor prepands initialize operators.</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">Operator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">create_parameter</span></code> is necessary because parameters are global variables, defined in the global block, but can be created in some sub-blocks. For example, an FC layer in the step block of an RNN operator.</p>
<p><code class="docutils literal"><span class="pre">prepend_operator</span></code> is necessary because the constructor of <code class="docutils literal"><span class="pre">Parameter</span></code> needs to create the initialize (or load) operator of the parameter, and would like to put it in the <em>preamble</em> of the global block.</p>
</div>
<div class="section" id="operator">
<span id="operator"></span><h3>Operator<a class="headerlink" href="#operator" title="永久链接至标题">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">Operator</span></code> class fills in the <code class="docutils literal"><span class="pre">OpDesc</span></code> message and calls the C++ function <code class="docutils literal"><span class="pre">InferShape</span></code> to infer the output shapes from the input shapes.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Operator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">block</span><span class="p">,</span>  <span class="c1"># Block</span>
                 <span class="nb">type</span><span class="p">,</span>   <span class="c1"># string</span>
                 <span class="n">inputs</span><span class="p">,</span> <span class="c1"># dict&lt;string, Variable&gt;</span>
                 <span class="n">outputs</span><span class="p">,</span><span class="c1"># dict&lt;stirng, Variable&gt;</span>
                 <span class="n">attrs</span>   <span class="c1"># dict&lt;string, Any&gt;</span>
                 <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">NewOpDesc</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="n">core</span><span class="o">.</span><span class="n">infer_shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="o">.</span><span class="n">type</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">Operator</span></code> creates the <code class="docutils literal"><span class="pre">OpDesc</span></code> message in C++ space, so that it can call the <code class="docutils literal"><span class="pre">InferShape</span></code> function, which is in C++.</p>
</div>
<div class="section" id="variable">
<span id="variable"></span><h3>Variable<a class="headerlink" href="#variable" title="永久链接至标题">¶</a></h3>
<p>Operators take Variables as its inputs and outputs.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Variable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">block</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>      <span class="c1"># Block</span>
                 <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>       <span class="c1"># string</span>
                 <span class="n">shape</span><span class="p">,</span>           <span class="c1"># tuple</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="c1"># string</span>
                 <span class="n">lod_level</span><span class="o">=</span><span class="bp">None</span>   <span class="c1"># int</span>
                 <span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">unique_name_generator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">NewVarDesc</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">desc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">lod_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>Please be aware of <code class="docutils literal"><span class="pre">self.writer</span></code>, that tracks operator who creates the variable.  It possible that there are more than one operators who write a variable, but in Python space, each write to a variable is represented by a Variable class.  This is guaranteed by the fact that <strong><code class="docutils literal"><span class="pre">core.NewVarDesc</span></code> must NOT create a new <code class="docutils literal"><span class="pre">VarDesc</span></code> message if its name already exists in the specified block</strong>.</p>
</div>
<div class="section" id="parameter">
<span id="parameter"></span><h3>Parameter<a class="headerlink" href="#parameter" title="永久链接至标题">¶</a></h3>
<p>A parameter is a global variable with an initializer (or load) operator.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Variable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">block</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>      <span class="c1"># Block</span>
                 <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>       <span class="c1"># string</span>
                 <span class="n">shape</span><span class="p">,</span>           <span class="c1"># tuple</span>
                 <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="c1"># string</span>
                 <span class="n">lod_level</span><span class="o">=</span><span class="bp">None</span>   <span class="c1"># int</span>
                 <span class="n">trainable</span><span class="p">,</span>       <span class="c1"># bool</span>
                 <span class="n">initialize_op_attrs</span><span class="p">,</span>
                 <span class="n">optimize_op_attrs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Parameter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">lod_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="n">trainable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimize_op_attrs</span> <span class="o">=</span> <span class="n">optimize_op_attrs</span>
        <span class="n">block</span><span class="o">.</span><span class="n">prepend</span><span class="p">(</span><span class="n">Operator</span><span class="p">(</span><span class="n">block</span><span class="p">,</span>  <span class="c1"># Block</span>
                               <span class="n">initialize_op_attrs</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>   <span class="c1"># string</span>
                               <span class="bp">None</span><span class="p">,</span>   <span class="c1"># no inputs</span>
                               <span class="bp">self</span><span class="p">,</span>   <span class="c1"># output is the parameter</span>
                               <span class="n">initialize_op_attrs</span><span class="p">)</span>
</pre></div>
</div>
<p>When users create a parameter, they can call</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">program</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span>
  <span class="o">...</span><span class="p">,</span>
  <span class="n">init_attr</span><span class="o">=</span><span class="p">{</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;uniform_random&quot;</span><span class="p">,</span>
    <span class="nb">min</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="nb">max</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
  <span class="p">})</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In above example, <code class="docutils literal"><span class="pre">init_attr.type</span></code> names an initialize operator.  It can also name the load operator</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">init_attr</span><span class="o">=</span><span class="p">{</span>
 <span class="nb">type</span><span class="p">:</span> <span class="s2">&quot;load&quot;</span><span class="p">,</span>
 <span class="n">filename</span><span class="p">:</span> <span class="s2">&quot;something.numpy&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">optimize_op_attrs</span></code> is not in the <code class="docutils literal"><span class="pre">VarDesc</span></code> message, but kept in the Python instance, as it will be used in the Python space when creating the optimize operator&#8217;s <code class="docutils literal"><span class="pre">OpDesc</span></code>, and will be in the <code class="docutils literal"><span class="pre">OpDesc</span></code> message.</p>
</div>
</div>
<div class="section" id="layer-function">
<span id="layer-function"></span><h2>Layer Function<a class="headerlink" href="#layer-function" title="永久链接至标题">¶</a></h2>
<p>A layer is a Python function that creates some operators and variables. Layers simplify the work of application programmers.</p>
<p>Layer functions take <code class="docutils literal"><span class="pre">Variable</span></code> and configuration parameters as its input and return the output variable(s).</p>
<p>For example, <code class="docutils literal"><span class="pre">FullyConnected</span></code> take one or more variable as its input. The input could be input data or another layer&#8217;s output. There are many configuration options for a <code class="docutils literal"><span class="pre">FullyConnected</span></code> layer, such as layer size, activation, parameter names, initialization strategies of parameters, and so on. The <code class="docutils literal"><span class="pre">FullyConnected</span></code> layer will return an output variable.</p>
<div class="section" id="necessity-for-reusing-code-between-layer-functions">
<span id="necessity-for-reusing-code-between-layer-functions"></span><h3>Necessity for reusing code between layer functions<a class="headerlink" href="#necessity-for-reusing-code-between-layer-functions" title="永久链接至标题">¶</a></h3>
<p>There are a lot of code that can be reused. Such as</p>
<ul class="simple">
<li>Give the default value of configuration. e.g., default initialize strategy for parameters is uniform random with <code class="docutils literal"><span class="pre">min</span> <span class="pre">=</span> <span class="pre">-1.0</span></code>, <code class="docutils literal"><span class="pre">max</span> <span class="pre">=</span> <span class="pre">1.0</span></code>. and default initialize strategy for bias is to fill zero.</li>
<li>Append the activation operator.</li>
<li>Create a temporary variable.</li>
<li>Create parameter.</li>
<li>Generate a unique name.</li>
<li>Add a bias.</li>
<li>...</li>
</ul>
<p>A mechanism to reuse code between layer functions is necessary. It will be around <a class="reference external" href="https://github.com/PaddlePaddle/Paddle/pull/4724/files#diff-823b27e07e93914ada859232ae23f846R12">150 lines of code</a> if we write a <code class="docutils literal"><span class="pre">FullyConnected</span></code> layer without any helper functions.</p>
</div>
<div class="section" id="comparision-between-global-functions-and-helper-class">
<span id="comparision-between-global-functions-and-helper-class"></span><h3>Comparision between global functions and helper class<a class="headerlink" href="#comparision-between-global-functions-and-helper-class" title="永久链接至标题">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">FullyConnected</span></code> layer will be as follow when we provide global functions:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fc_layer</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">param_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bias_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">unique_name</span><span class="p">(</span><span class="s2">&quot;fc&quot;</span><span class="p">)</span>
  <span class="nb">input</span> <span class="o">=</span> <span class="n">multiple_input</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
  <span class="n">param_attr</span> <span class="o">=</span> <span class="n">default_param_attr</span><span class="p">(</span><span class="n">param_attr</span><span class="p">)</span>
  <span class="n">param_attr</span> <span class="o">=</span> <span class="n">multiple_param_attr</span><span class="p">(</span><span class="n">param_attr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">))</span>

  <span class="c1"># mul</span>
  <span class="n">mul_results</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">ipt</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">param_attr</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">ipt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">size</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">g_program</span><span class="o">.</span><span class="n">global_block</span><span class="p">()</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">ipt</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">create_tmp_var</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">g_program</span><span class="o">.</span><span class="n">current_block</span><span class="p">()</span><span class="o">.</span><span class="n">append_op</span><span class="p">(</span><span class="s2">&quot;mul&quot;</span><span class="p">,</span> <span class="p">{</span><span class="n">ipt</span><span class="p">,</span> <span class="n">w</span><span class="p">},</span> <span class="p">{</span><span class="n">tmp</span><span class="p">})</span>
  <span class="n">mul_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

  <span class="c1"># add sum</span>
  <span class="o">...</span>
  <span class="c1"># add bias</span>
  <span class="o">...</span>
  <span class="c1"># add activation</span>
  <span class="o">...</span>
  <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
<p>We can provide many helpers functions for layer developers. However, there are several disadvantages for global helper functions:</p>
<ol class="simple">
<li>We need a namespace for these methods, then layer developers can quickly figure out what method they can use.</li>
<li>Global functions will force layer developers to pass its parameter time by time.</li>
</ol>
<p>So we provide a helper class, <code class="docutils literal"><span class="pre">LayerHelper</span></code>, to share code between layer functions. The <code class="docutils literal"><span class="pre">FullyConnected</span></code> Layer will be as follow.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fc_layer</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">param_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bias_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">act</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="n">helper</span> <span class="o">=</span> <span class="n">LayerHelper</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>  <span class="c1"># pass all parameter to LayerHelper</span>

  <span class="n">mul_results</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="n">ipt</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">helper</span><span class="o">.</span><span class="n">iter_multiple_input_and_param</span><span class="p">():</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">create_parameter</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">ipt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">ipt</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">create_tmp_variable</span><span class="p">()</span>
    <span class="n">helper</span><span class="o">.</span><span class="n">append_op</span><span class="p">(</span><span class="s1">&#39;mul&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">ipt</span><span class="p">,</span> <span class="n">w</span><span class="p">},</span> <span class="p">{</span><span class="n">tmp</span><span class="p">})</span>
    <span class="n">mul_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

  <span class="n">pre_bias</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">add_sum</span><span class="p">(</span><span class="n">mul_results</span><span class="p">)</span>
  <span class="n">pre_activation</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">add_bias</span><span class="p">(</span><span class="n">pre_bias</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">helper</span><span class="o">.</span><span class="n">add_activation</span><span class="p">(</span><span class="n">pre_activation</span><span class="p">)</span>
</pre></div>
</div>
<p>We not only use the fewer lines of code to write <code class="docutils literal"><span class="pre">fc_layer</span></code> but also make the code clearer to understand. At the same time, layer developers can figure out what function they can invoke by typing <code class="docutils literal"><span class="pre">helper.</span></code> in a python editor.</p>
</div>
<div class="section" id="implementation-of-layer-helper">
<span id="implementation-of-layer-helper"></span><h3>Implementation of layer helper<a class="headerlink" href="#implementation-of-layer-helper" title="永久链接至标题">¶</a></h3>
<p>We just keep all parameters of a layer function as a dictionary in layer helper as a private data member. Every method of layer helper will look up the dictionary after it is invoked. In that way, we can implement a layer helper for all layer functions even some layer does not contain some operator. For example, The <code class="docutils literal"><span class="pre">activation</span></code> is used by the FullyConnected layer or convolution layers, but a cross-entropy layer does not use it. The example code of <code class="docutils literal"><span class="pre">add_activation</span></code> are:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LayerHelper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># kwargs is short for `keyword arguments`</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

  <span class="k">def</span> <span class="nf">add_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_var</span><span class="p">):</span>
    <span class="n">act</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;act&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>  <span class="c1"># default value is None</span>
    <span class="k">if</span> <span class="n">act</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c1"># do nothing if no act</span>
      <span class="k">return</span> <span class="n">input_var</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_tmp_var</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">append_op</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">act</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">input_var</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tmp</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="optimizer">
<span id="optimizer"></span><h2>Optimizer<a class="headerlink" href="#optimizer" title="永久链接至标题">¶</a></h2>
<p><a class="reference internal" href="optimizer.html"><span class="doc">Optimizer Design Doc</span></a></p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, PaddlePaddle developers.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ".txt",
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.0/MathJax.js"></script>
       
  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  
  
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/perfect-scrollbar/0.6.14/js/perfect-scrollbar.jquery.min.js"></script>
  <script src="../_static/js/paddle_doc_init.js"></script> 

</body>
</html>